"use strict";(self.webpackChunk_720yun_tour_player=self.webpackChunk_720yun_tour_player||[]).push([[55],{33055:function(e,t,n){n.r(t),n.d(t,{default:function(){return H}});n(30489),n(12419),n(41539),n(88674),n(82526),n(41817),n(32165),n(66992),n(78783),n(33948),n(35666),n(92222),n(74916),n(64765);var r,o=n(67294),a="PaidViewingWp--m2swa",i="PaidViewing--_E__z",c="loginWp--j3Mm9",u="button--G4VLO",s="loginButton--e2rS_",p="qrcodeWp--_Jfyf",l="qrcode--xE8WV",f="amount--ClX7n",d="describe--_J_uD",m=n(92317),y=n(88860),b=n(46458),g=n(1678);function h(e){return h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},h(e)}function v(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function w(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function O(e,t){return O=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},O(e,t)}function k(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=x(e);if(t){var o=x(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return _(this,n)}}function _(e,t){if(t&&("object"===h(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return P(e)}function P(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function x(e){return x=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},x(e)}function S(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var I=(0,b.$j)((function(e){return{krp:e.common.krp}}))(r=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&O(e,t)}(i,e);var t,n,r,a=k(i);function i(){var e;v(this,i);for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return S(P(e=a.call.apply(a,[this].concat(n))),"loginComplete",(function(){e.props.dispatch({type:"member/me"})})),e}return t=i,(n=[{key:"render",value:function(){var e=this.props,t=e.isOpen,n=e.onClose,r=e.onWxAuth,a=e.defaultTab,i=void 0===a?"login":a;return o.createElement(g._,{onWxAuth:r,isOpen:t,apiDomain:y.API_DOMAIN,sslApiDomain:y.API_DOMAIN,onComplete:this.loginComplete,onRequestClose:n,defaultTab:i})}}])&&w(t.prototype,n),r&&w(t,r),i}(o.PureComponent))||r,C=I,E=n(86112),N=n(94315),L=n.n(N),R=(n(4723),window.navigator.userAgent.toLowerCase());var j,A=/720yun aUWCj8QTNX2REohWFEawgioK6LBwm72W/i.test(R)?"app":L().mobile()&&"micromessenger"==R.match(/MicroMessenger/i)?"wx":"qq/"==R.match(/QQ\//i)?"qq":L().mobile()?"h5":"pc",T=n(31955);function W(e){return W="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},W(e)}function D(e,t,n,r,o,a,i){try{var c=e[a](i),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(r,o)}function M(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){D(a,r,o,i,c,"next",e)}function c(e){D(a,r,o,i,c,"throw",e)}i(void 0)}))}}function q(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function B(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function V(e,t){return V=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},V(e,t)}function Q(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=U(e);if(t){var o=U(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return Z(this,n)}}function Z(e,t){if(t&&("object"===W(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return F(e)}function F(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function U(e){return U=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},U(e)}function J(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var X=!1;navigator.userAgent.toLowerCase().indexOf("micromessenger")>=0&&(X=!0);var z=(0,b.$j)((function(e){var t,n,r,o,a=e.member,i=e.common,c=e.contrast,u=a.isLogin,s=a.avatar,p=a.uid,l=a.id,f=a.init,d=a.isPaid,m=null===(t=i.product)||void 0===t||null===(n=t.config)||void 0===n||null===(r=n.vipView)||void 0===r?void 0:r.payment,y=null===(o=i.product)||void 0===o?void 0:o.freeScenes,b=c.isContrast;return{memberId:l,isLogin:u,avatar:s,memberUid:p,initLogin:f,payment:m,freeScenes:y,tid:i.product.tid,isPaid:d,id:i.product.id,krp:i.krp,currentSceneId:i.currentScene.id,currentSceneType:i.currentScene.type,isContrast:b}}))(j=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&V(e,t)}(g,e);var t,n,r,b=Q(g);function g(){var e;q(this,g);for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return J(F(e=b.call.apply(b,[this].concat(n))),"state",{qrcode:null}),J(F(e),"openBindPhone",(function(){1==localStorage.getItem("720_login_bind")&&(localStorage.removeItem("720_login_bind"),e.props.isLogin||e.setState({isOpenLogin:!0,loginTab:"bind"}))})),J(F(e),"onLogin",M(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.props.dispatch({type:"member/checkIsPaid"});case 2:e.props.isPaid?e.payComplete():X?e.getOpenId():e.getOrderNo();case 4:case"end":return t.stop()}}),t)})))),J(F(e),"checkPay",M(regeneratorRuntime.mark((function t(){var n,r,o;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,E.Z)(1e3);case 2:return n=e.state.orderNo,t.next=5,m.Z.get("".concat(y.API_DOMAIN,"/member/my/vipview/cash/orders/").concat(n));case 5:r=t.sent,o=r.data,1===r.success&&2===o.status?e.payComplete():e.checkPay();case 9:case"end":return t.stop()}}),t)})))),J(F(e),"payComplete",(function(){e.props.dispatch({type:"member/save",payload:{isPaid:!0,isPaidInit:!0}}),e.props.dispatch({type:"modals/close"}),e.props.isContrast||e.props.krp.initUI()})),J(F(e),"init",M(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.props.isLogin){t.next=3;break}return t.abrupt("return",e.props.dispatch({type:"member/me"}));case 3:X?e.getOpenId():e.getOrderNo();case 4:case"end":return t.stop()}}),t)})))),J(F(e),"jsPay",function(){var t=M(regeneratorRuntime.mark((function t(n,r){var o;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return 3,t.next=3,m.Z.post("".concat(y.API_DOMAIN,"/member/pay/wxpay-js/").concat(3,"/").concat(n),{openId:r});case 3:if(1===(o=t.sent).success){t.next=6;break}return t.abrupt("return");case 6:e.loading=!0,window.wx.chooseWXPay({appId:o.data.appId,paySign:o.data.paySign,nonceStr:o.data.nonceStr,package:o.data.package,timestamp:o.data.timeStamp,signType:o.data.signType,success:function(){e.checkPay()},fail:function(t){e.loading=!1},cancel:function(t){e.loading=!1}});case 8:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}()),J(F(e),"getOpenId",(function(){var t;return X&&!(t=T.Z.get("720yun_wx_member_openid"))?(e.onWxAuth(),void(window.location.href="".concat(y.HOST,"/wx-auth/openid?referer=").concat(window.location.pathname).concat(window.location.search))):t})),J(F(e),"getOrderNo",M(regeneratorRuntime.mark((function t(){var n,r,o,a,i,c,u,s,p;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.loading){t.next=2;break}return t.abrupt("return");case 2:n=e.props,r=n.payment,o=n.tid,a=n.id,i=n.memberId,n.sceneId,c=e.getOpenId(),u=0,t.t0=A,t.next="wx"===t.t0?8:"h5"===t.t0||"qq"===t.t0?10:"app"===t.t0?12:14;break;case 8:return u=1,t.abrupt("break",15);case 10:return u=2,t.abrupt("break",15);case 12:return u=L().android()?4:3,t.abrupt("break",15);case 14:u=0;case 15:return s={payMethod:2,source:u,payment:r,dataType:0,dataId:a,dataHashId:o,dataMemberId:i},t.next=18,m.Z.post("".concat(y.API_DOMAIN,"/member/my/pay/vipview/cash"),s);case 18:if(1===(p=t.sent).success){t.next=21;break}return t.abrupt("return",console.error("获取订单失败"));case 21:if(!X){t.next=27;break}return e.setState({orderNo:p.data}),t.next=25,e.jsPay(p.data,c);case 25:t.next=28;break;case 27:e.setState({orderNo:p.data},e.checkPay);case 28:case"end":return t.stop()}}),t)})))),J(F(e),"onCloseLogin",(function(){e.setState({isOpenLogin:!1})})),J(F(e),"onOpenLogin",(function(){e.setState({isOpenLogin:!0,loginTab:"login"})})),J(F(e),"onClickFree",(function(){var t=e.props,n=t.freeScenes;t.isContrast?e.props.dispatch({type:"contrast/sceneChange",sceneId:n[0]}):e.props.dispatch({type:"common/sceneChange",payload:{sceneId:n[0]}})})),J(F(e),"renderQRCode",(function(){var t=e.props,n=t.isLogin;if(!t.initLogin)return null;if(!n)return X?o.createElement("div",{onClick:e.onOpenLogin,className:"".concat(u)},"登录账户"):o.createElement("div",{className:c},o.createElement("div",{onClick:e.onOpenLogin,className:"".concat(s," ").concat(u)},"登录账户"));if(X)return o.createElement("div",null,o.createElement("div",{onClick:e.getOrderNo,className:"".concat(u)},"立即支付"));var r=e.state.orderNo;return r?o.createElement("img",{className:l,src:"".concat(y.API_DOMAIN,"/member/pay/wxpay/3/").concat(r),alt:""}):null})),J(F(e),"renderTip",(function(){var t=e.props,n=t.isLogin;return t.initLogin&&n?X?null:"请使用微信扫码支付":null})),J(F(e),"onWxAuth",(function(){var t={currentSceneId:e.props.currentSceneId};localStorage.setItem("wx-auth-simple",JSON.stringify(t))})),e}return t=g,(n=[{key:"componentDidMount",value:function(){this.init(),this.openBindPhone()}},{key:"componentDidUpdate",value:function(e,t){!e.isLogin&&this.props.isLogin&&this.onLogin()}},{key:"render",value:function(){var e=this.state,t=e.isOpenLogin,n=e.loginTab,r=this.props,c=r.payment,s=r.freeScenes;return o.createElement("div",{className:a},o.createElement(C,{onWxAuth:this.onWxAuth,isOpen:t,onClose:this.onCloseLogin,referer:"PaidViewing",defaultTab:n}),o.createElement("div",{className:i},o.createElement("div",{style:{fontSize:20}},"需付费浏览"),o.createElement("div",{className:f},"支付金额：¥",c),o.createElement("div",{style:{marginTop:20}},"应创作者要求，当前场景需要付费后才能浏览，成功付费后可解锁当前作品所有场景的观看权限"),o.createElement("div",{className:p},this.renderQRCode()),o.createElement("div",{className:d,style:{marginTop:8}},this.renderTip()),o.createElement("div",{className:d,style:{marginTop:20}},"支付即代表您已阅读并同意",o.createElement("a",{style:{color:"#286EFA"},href:"https://www.720yun.com/bbs/article?id=1424",target:"_blank",rel:"noopener noreferrer"},"《720云内容付费查看协议》")),s.length>0?o.createElement("div",{onClick:this.onClickFree,style:{marginTop:20},className:"".concat(u)},"返回免费场景"):null))}}])&&B(t.prototype,n),r&&B(t,r),g}(o.PureComponent))||j,H=z}}]);